import { useState, useEffect } from "react";
import { motion } from "framer-motion";

export default function App() {
  const [mode, setMode] = useState(null); // "water" or "help"
  const [plant, setPlant] = useState("");
  const [availablePlants, setAvailablePlants] = useState([]);
  const [result, setResult] = useState(null);
  const [flowers, setFlowers] = useState([]);

  const API_KEY = "sk-bJio68b47a9d56aff12144"; // replace with your Perenual API key

  const addFlower = () => {
    const id = Date.now();
    setFlowers([...flowers, id]);
    setTimeout(() => setFlowers((f) => f.filter((x) => x !== id)), 4000);
  };

  const handleSelect = (choice) => {
    setMode(choice);
    setResult(null);
    setPlant("");
    addFlower();
  };

  useEffect(() => {
    const fetchPlants = async () => {
      try {
        const res = await fetch(
          `https://perenual.com/api/species-list?key=${API_KEY}`
        );
        const data = await res.json();
        const names = data.data.map((p) => p.common_name).filter(Boolean);
        setAvailablePlants(names);
      } catch (err) {
        console.error("Error fetching plant list:", err);
      }
    };
    fetchPlants();
  }, []);

  const fetchPlantInfo = async () => {
    if (!plant) return;
    addFlower();

    try {
      const res = await fetch(
        `https://perenual.com/api/species-list?key=${API_KEY}&q=${plant}`
      );
      const data = await res.json();
      const plantData = data.data?.[0];

      if (!plantData) {
        setResult("No data available for this plant.");
        return;
      }

      let message = `ğŸŒ¿ Info for ${plantData.common_name || plant}:\n`;

      if (mode === "water") {
        message += `ğŸ’§ Watering: ${
          plantData.watering || "Water moderately based on soil moisture"
        }\n`;
        message += `â˜€ï¸ Sunlight: ${
          plantData.sunlight || "Adjust light according to plant type"
        }\n`;
        message += `ğŸª´ Soil: ${
          plantData.soil_type || "Use well-draining soil"
        }`;
      } else if (mode === "help") {
        message += `ğŸŒ± Propagation: ${
          plantData.propagation || "Try adjusting sunlight, water, or soil"
        }\n`;
        message += `ğŸŒ¡ï¸ Temperature: ${
          plantData.temperature || "Keep in moderate indoor temperatures"
        }\n`;
        message += `â˜€ï¸ Sunlight: ${
          plantData.sunlight || "Adjust light according to plant type"
        }\n`;
        message += `ğŸ’§ Watering: ${
          plantData.watering || "Water moderately based on soil moisture"
        }`;
      }

      setResult(message);
    } catch (err) {
      setResult("Network error. Please check your connection.");
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-green-50 p-6 relative">
      <h1 className="text-3xl font-bold mb-6">ğŸŒ± Plant Care Assistant</h1>

      {/* Buttons */}
      <div className="flex gap-4 mb-6">
        <button onClick={() => handleSelect("water")}>
          How much to water plants
        </button>
        <button onClick={() => handleSelect("help")}>
          My plant isnâ€™t doing well
        </button>
      </div>

      {/* Dropdown + Search */}
      {mode && (
        <div className="w-full max-w-md border p-4 rounded flex flex-col gap-2">
          <select
            value={plant}
            onChange={(e) => setPlant(e.target.value)}
            className="border p-2 rounded w-full"
          >
            <option value="">Select a plant...</option>
            {availablePlants.map((p, i) => (
              <option key={i} value={p}>
                {p}
              </option>
            ))}
          </select>
          <button onClick={fetchPlantInfo}>Search</button>

          {result && (
            <pre className="mt-4 text-lg whitespace-pre-wrap">{result}</pre>
          )}
        </div>
      )}

      {/* Flower border at the bottom */}
      <div className="absolute bottom-0 left-0 w-full flex justify-between px-4">
        {Array.from({ length: 15 }).map((_, i) => (
          <motion.div
            key={i}
            className="text-pink-400 text-2xl"
            initial={{ y: 20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{ delay: i * 0.1, duration: 1 }}
          >
            ğŸŒ¸
          </motion.div>
        ))}
      </div>
    </div>
  );
}